angular.module("ngWebSql",[]).factory("$db",["$window","$q",function(n,e){var o=this;return o.db=null,o.config=null,o.initialized=!1,o.init=function(i){var r=[],t=e.defer();o.config=i,o.config.logging=o.config.hasOwnProperty("logging")?o.config.logging:!1,o.config.logging&&console.log("Initializing Database: "+i.name),o.db=n.sqlitePlugin?n.sqlitePlugin.openDatabase({name:i.name}):n.openDatabase(i.name,"1.0","database",-1);try{angular.forEach(o.config.tables,function(n){var e=[];angular.forEach(n.columns,function(n){e.push(n.name+" "+n.type+(n.is_null?"":" NOT")+" NULL"+(n.hasOwnProperty("default")?" DEFAULT ("+n["default"]+")":""))}),n.primary_key&&e.push("PRIMARY KEY ("+n.primary_key.join(",")+")"),n.foreign_keys&&angular.forEach(n.foreign_keys,function(n){e.push("CONSTRAINT '"+n.name+"' FOREIGN KEY ('"+n.foreign_key+"') REFERENCES '"+n.references+"' ('"+n.primary_key+"')")}),n.uniques&&angular.forEach(n.uniques,function(n){e.push("UNIQUE("+n.fields.join(",")+")")});var i="CREATE TABLE IF NOT EXISTS "+n.name+" ( "+e.join(",")+" )";n.without_rowid&&(i+=" WITHOUT ROWID"),r.push(o.query(i).then(function(){o.config.logging&&console.log("Initialized Table: "+n.name)},function(n){o.config.logging&&console.log(n)})),angular.forEach(n.indexes,function(e){r.push(o.query("CREATE "+(e.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS "+e.name+" ON "+n.name+" ( "+e.columns.join(",")+" )").then(function(){o.config.logging&&console.log("Created Index: "+e.name)},function(n){o.config.logging&&console.log(n)}))})}),angular.forEach(o.config.views,function(n){r.push(o.query("CREATE "+(n.temp?"TEMP ":"")+"VIEW IF NOT EXISTS "+n.name+" AS "+n.statement).then(function(){o.config.logging&&console.log("Created View: "+n.name)},function(n){o.config.logging&&console.log(n)}))}),e.all(r).then(function(){o.initialized=!0,o.config.logging&&console.log("Database Initialized"),t.resolve()})}catch(a){t.reject(a)}return t.promise},o.query=function(n,i){var r=e.defer();return i="undefined"!=typeof i?i:[],o.db.transaction(function(e){e.executeSql(n,i,function(n,e){r.resolve(e)},function(n,e){r.reject(e)})}),r.promise},o.drop=function(n,i){var r=e.defer();return-1==="TABLE,INDEX,VIEW".indexOf(i.toUpperCase())?r.reject("Invalid object type"):o.query("DROP "+i+" "+n).then(function(){r.resolve()}),r.promise},o.index=function(n,i,r,t){var a=e.defer();return e.all([o.query("DROP INDEX "+n),o.query("CREATE "+(t?"UNIQUE ":"")+"INDEX "+n+" ON "+i+" ( "+r.join(",")+" )")]).then(function(){a.resolve()}),a.promise},o.view=function(n,i,r){var t=e.defer();return e.all([o.query("DROP VIEW "+n),o.query("CREATE "+(r?"TEMP ":"")+"VIEW "+n+" AS "+i)]).then(function(){t.resolve()}),t.promise},o.recreate=function(){var n=[],i=e.defer();return o.config.logging&&console.log("Recreating Database: "+o.config.name),angular.forEach(o.config.tables,function(e){n.push(o.query("DROP TABLE "+e.name))}),e.all(n).then(function(){o.init(o.config).then(function(){o.config.logging&&console.log("Successfully Recreated Database: "+o.config.name),i.resolve()},function(n){o.config.logging&&console.log("Failed to Recreate Database: "+o.config.name),i.reject(n)})}),i.promise},o.columns=function(n){return o.query("SELECT * FROM sqlite_master WHERE type = 'table' AND name = ? LIMIT 1",[n],!0).then(function(n){return o.row(n)}).then(function(n){var e=n.sql.replace(/^[^(]+\(\s*/,"").replace(/,?primary\skey.*$/i,"").replace(/(\(|\)).*$/,"").replace(/\s[^,]+/g,"");return e.split(",")})},o.resultset=function(n){for(var e=[],o=0;o<n.rows.length;o++)e.push(n.rows.item(o));return e},o.row=function(n,e){return e=e||0,n.rows.length&&n.rows[e]?n.rows.item(e):{}},o}]);